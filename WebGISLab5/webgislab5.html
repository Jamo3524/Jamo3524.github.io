<!DOCTYPE html>
<html>
  <head>
    <title>Leaflet practice</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
      integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
      integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
      crossorigin=""
    ></script>

    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    <script src="leaflet-knn.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-search/3.0.9/leaflet-search.src.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-search/3.0.9/leaflet-search.src.js"></script>

    <script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js"></script>
    <link
      href="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div id="map" style="width: 1000px; height: 550px"></div>

    <script type="text/javascript">
      //OSM tiles attribution and URL
      var osmLink = '<a href="http://openstreetmap.org">OpenStreetMap</a>';
      var osmURL = "http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";
      var osmAttrib = "&copy; " + osmLink;

      //Carto tiles attribution and URL
      var cartoLink = '<a href="http://cartodb.com/attributions">CartoDB</a>';
      var cartoURL =
        "http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png";
      var cartoAttrib = "&copy; " + osmLink + " &copy; " + cartoLink;

      //Stamen Toner tiles attribution and URL
      var stamenURL =
        "http://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.{ext}";
      var stamenAttrib =
        'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>';

      //Creation of map tiles
      var osmMap = L.tileLayer(osmURL, { attribution: osmAttrib });
      var cartoMap = L.tileLayer(cartoURL, { attribution: cartoAttrib });
      var stamenMap = L.tileLayer(stamenURL, {
        attribution: stamenAttrib,
        subdomains: "abcd",
        minZoom: 0,
        maxZoom: 20,
        ext: "png",
      });

      //Map creation
      var map = L.map("map", {
        layers: [osmMap],
        fullscreenControl: true,
      }).setView([39.021574, -101.751127], 4);

      //Base layers definition and addition

      var baseLayers = {
        Openstreetmap: osmMap,
        "Carto DarkMatter": cartoMap,
        "Stamen Toner": stamenMap,
      };

      //Add baseLayers to map as control layers

      function onEachFeature(feature, layer) {
        var popupContent =
          "<p>Name: " +
          feature.properties.NAME +
          "</br> Water area: " +
          feature.properties.AWATER +
          " sq m" +
          "</p>";

        if (feature.properties && feature.properties.popupContent) {
          popupContent += feature.properties.popupContent;
        }

        layer.bindPopup(popupContent);

        layer.on("mouseover", function () {
          layer.openPopup();
        });
        layer.on("mouseover", function () {
          layer.setStyle({ fillColor: "#1d23f0" })();
        });
        layer.on("mouseout", function () {
          layer.closePopup();
        });
        layer.on("mouseout", function () {
          states.resetStyle();
        });
      }

      var states = L.geoJSON(null, {
        style: function (feature) {
          return { color: "#555", fill: "#555" };
        },
        onEachFeature: onEachFeature,
      }).addTo(map);

      fetch("usStates18.geojson")
        .then((response) => {
          return response.json();
        })
        .then((data) => {
          console.log(data);
          var maxVal = -Infinity,
            minVal = Infinity;
          var allVals = [];
          //Symbolizing based on water area in each state
          data.features.forEach((f, i) => {
            //                    if (f.properties.NAME != 'Alaska' && f.properties.NAME != 'Hawaii')
            {
              maxVal = Math.max(maxVal, f.properties.AWATER);
              minVal = Math.min(minVal, f.properties.AWATER);
              allVals.push(f.properties.AWATER);
            }
          });

          var valRange = maxVal - minVal;
          var colIntpl = d3
            .scaleQuantile()
            .domain(allVals)
            .range(d3.schemePurples[9]);

          states.options.style = (f) => {
            return {
              fillColor: colIntpl(f.properties.AWATER),
              color: "#fff",
              weight: 1,
              fillOpacity: 0.8,
            };
          };

          states.myExtraData = [
            maxVal,
            minVal,
            valRange,
            d3.scalePow().exponent(0.5).domain([0, maxVal]).range([0, 20]),
          ];

          states.addData(data);
        });

      var monitors = L.geoJSON(null, {
        style: function (feature) {
          return { color: "#555", fill: "#555" };
        },
      }).addTo(map);

      $.getJSON("no2.geojson", function (data) {
        monitors.addData(data);
      });

      var gisLayers = {
        "US States": states,
        "NO2 Monitoring Locations": monitors,
      };

      var layerControl = L.control.layers(baseLayers, gisLayers).addTo(map);

      searchIndex = leafletKnn(monitors);

      map.on("click", function (ev) {
        // Perform a KNN search with maximum 1 element in the result set,
        // then pick the first result from the result set.
        var nearestResult = searchIndex.nearest(ev.latlng, 1)[0];

        // ... as well as a 'layer' property containing the reference to the `L.Layer`,
        // which we can do something with.
        nearestResult.layer
          .bindPopup("I'm nearest to where you clicked!")
          .openPopup();
        console.log(nearestResult);
      });

      var searchControl = new L.Control.Search({
        layer: states,
        propertyName: "NAME",
        position: "topright",
        marker: false,
        moveToLocation: function (latlng, title, map) {
          //map.fitBounds( latlng.layer.getBounds() );
          let zoom = map.getBoundsZoom(latlng.layer.getBounds());
          map.setView(latlng, zoom); // access the zoom
        },
      });

      searchControl
        .on("search:locationfound", function (e) {
          e.layer.setStyle({ fillColor: "#3f0", color: "#0f0" });
          if (e.layer._popup) e.layer.openPopup();
        })
        .on("search:collapsed", function (e) {
          featuresLayer.eachLayer(function (layer) {
            //restore feature color
            featuresLayer.resetStyle(layer);
          });
        });

      map.addControl(searchControl); //inizialize search control
    </script>
  </body>
</html>
